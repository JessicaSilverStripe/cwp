<h1 id="adding-a-calendar">Adding a calendar</h1>
<p>This how-to will guide a developer wanting to add a custom event calendar into his own template. The <strong>Event Pages</strong> and <strong>Event Holders</strong> are created separately and as normal- this tutorial does not depend on any special site tree setup.</p>
<h2 id="obtaining-the-events">Obtaining the events</h2>
<p>First of all we need to decide which events will be included in the calendar. Let's start with creating a calendar that will display all events available on the site.</p>
<p>One option would be to use SilverStripe Framework's ORM to create a normal <code>DataList</code> and feed that to the template. But to make things simpler (albeit less customisable) we also can use the wrapper function provided by the <code>EventHolder</code> class. Let's take a closer look at the function declaration.</p>
<pre><code>:::php
public static function AllEvents($parentID = null, $tagID = null, $dateFrom = null, $dateTo = null, $year = null,
        $monthNumber = null)</code></pre>
<p>Let's use this variant, since this already provides us with more options than we need. The only thing we are looking to control is the currently displayed month.</p>
<h2 id="the-get-parameters">The GET parameters</h2>
<p>The month selection may be done, as in the <code>EventHolder</code>, on the basis of the <code>year</code> and <code>month</code> GET parameters. The parameters can then be passed to <code>AllEvents</code> to produce a single-month listing.</p>
<p>We can create a function that will parse the params and provide us with a neat array of SQL-safe variables. We start by getting the parameters from the <code>SS_HTTPRequest</code>.</p>
<pre><code>:::php
public function parseEventParams() {
    $year = $this-&gt;request-&gt;getVar(&#39;year&#39;);
    $month = $this-&gt;request-&gt;getVar(&#39;month&#39;);</code></pre>
<p>We need to sanitise them before doing anything else.</p>
<pre><code>:::php
    if (isset($year)) $year = (int)$year;
    if (isset($month)) $month = (int)$month;</code></pre>
<p>Next, since the month without year doesn't have much sense, we make sure that we check for validity and reset to defaults if needed.</p>
<pre><code>:::php
    // Default to current month if either not provided.
    if (!isset($month) || !isset($year)) {
        $year = SS_Datetime::now()-&gt;Format(&#39;Y&#39;);
        $month = SS_Datetime::now()-&gt;Format(&#39;m&#39;);
    }</code></pre>
<p>Then we return the array with cleaned up data.</p>
<pre><code>:::php
    return array(
        &#39;year&#39; =&gt; $year,
        &#39;month&#39; =&gt; $month
    );
}</code></pre>
<p>Note that these parameters need to be <code>year</code> and <code>month</code>, since that's what <code>EventHolder</code> uses internally.</p>
<h2 id="obtaining-the-events-continued">Obtaining the events continued</h2>
<p>Now that we have the parameters available, we can combine that with <code>AllEvents</code> to fetch the data and show it in the template. Let's create a getter in the <code>Page_Controller</code> (or wherever you are attempting to create the calendar).</p>
<pre><code>:::php
public function SiteEvents() {
    $params = $this-&gt;parseEventParams();
    return EventHolder::AllEvents(null, null, null, null, $params[&#39;year&#39;], $params[&#39;month&#39;]);
}</code></pre>
<p>We can now access the events for the currently selected (or default) month in the template, say <code>Page.ss</code>. Here is how to iteratively loop through the events, or provide an alternative string if no events are found.</p>
<pre><code>:::ss
&lt;% if SiteEvents %&gt;
    &lt;% loop SiteEvents %&gt;
        &lt;div class=&quot;event-listing&quot;&gt;
            &lt;h4&gt;&lt;a href=&quot;$Link&quot;&gt;$Title&lt;/a&gt;&lt;/h4&gt;
            &lt;p&gt;$Date.Nice&lt;/p&gt;
        &lt;/div&gt;
    &lt;% end_loop %&gt;
&lt;% else %&gt;
    &lt;p&gt;No events. Please use the month picker below to select another period.&lt;/p&gt;
&lt;% end_if %&gt;</code></pre>
<p>We can already test this snippet of code (this is using the <em>default</em> theme, and Bootstrap <code>well</code> class, in a <code>span3</code>):</p>
<div class="figure">
<img src="_images/calendar-empty.jpg" /><p class="caption"></p>
</div>
<p>If we have no current events, we need to provide some GET parameters to hit a valid month. Let's try <code>?year=2013&amp;month=1</code>.</p>
<div class="figure">
<img src="_images/calendar-month.jpg" /><p class="caption"></p>
</div>
<p>That's pretty good.</p>
<h2 id="extracting-available-months">Extracting available months</h2>
<p>We now need an interface to select the valid months from the calendar. The data for this can easily be extracted by using <code>ExtractMonths</code> from <code>EventHolder</code> (see <code>EventHolder.php</code> for the more detailed description of the method). This function accepts a list of events to extract the months from, and also some state parameters: current URL, currently selected month and year.</p>
<p>Since we actually want to extract months from all events on the site, we will use <code>EventHolder::AllEvents</code> without parameters. Supplying current month and year allows <code>ExtractMonths</code> to provide us with a flag marking the current month so we can highlight it in the frontend.</p>
<pre><code>:::php
public function SiteEventMonths() {
    $params = $this-&gt;parseEventParams();

    return EventHolder::ExtractMonths(
        EventHolder::AllEvents(),
        null,
        $params[&#39;year&#39;],
        $params[&#39;month&#39;]
    );
}</code></pre>
<p>The data structure (detailed in <code>EventHolder</code> as well) will alow us to construct the template pagination control. Here is an example of this, with some extra comments added in (see at the bottom of this how-to for the full listing).</p>
<pre><code>:::ss
&lt;% if SiteEventMonths %&gt;
    &lt;div class=&quot;month-filter&quot;&gt;
        &lt;%-- Loop through years first --%&gt;
        &lt;% loop SiteEventMonths %&gt;
            &lt;h6 class=&quot;year&quot;&gt;$YearName:&lt;/h6&gt;
            &lt;ol class=&quot;nav nav-pills unstyled months&quot;&gt;
                &lt;%-- Then loop through months within each year --%&gt;
                &lt;% loop Months %&gt;
                    &lt;%-- use the Active, MonthLink and MonthName to produce the pagination --%&gt;
                    &lt;li &lt;% if Active %&gt;class=&quot;active&quot;&lt;% end_if %&gt;&gt;&lt;a href=&quot;$MonthLink.XML&quot;&gt;$MonthName&lt;/a&gt;&lt;/li&gt;
                &lt;% end_loop %&gt;
            &lt;/ol&gt;
        &lt;% end_loop %&gt;
    &lt;/div&gt;
&lt;% end_if %&gt;</code></pre>
<p>The <code>Active</code> will be set to true for the month that is the same as the currently selected one. The <code>MonthLink</code> is the link built on the basis of the current URL, plus the <code>year</code> and <code>month</code> GET params needed for selecting the relevant month. The <code>MonthName</code> is a three-letter shorthand for a month, such as &quot;Apr&quot;.</p>
<p>Here is how will the calendar appear with the month picker added in:</p>
<div class="figure">
<img src="_images/calendar-picker.jpg" /><p class="caption"></p>
</div>
<h2 id="limiting-the-events-in-the-calendar">Limiting the events in the calendar</h2>
<p>We don't have to display all events in the calendar. It's just as meaningful to show for example all events with a specific tag. The modification is simple. Get the tag using the ORM as you'd normally do, and provide its ID as the second parameter to both <code>AllEvents</code> function used in this how-to.</p>
<pre><code>:::php
// Get the tag
$tag = TaxonomyTerm::get()-&gt;filter(array(&#39;Name&#39; =&gt; &#39;Future&#39;))-&gt;First();
...
// Modify both AllEvents call in SiteEvents
return EventHolder::AllEvents(null, $tag-&gt;ID, null, null, $params[&#39;year&#39;], $params[&#39;month&#39;]);
...
// And in SiteEventMonths
return EventHolder::ExtractMonths(
    EventHolder::AllEvents(null, $tag-&gt;ID),
    null,
    $params[&#39;year&#39;],
    $params[&#39;month&#39;]
);</code></pre>
<p>That will filter out the events that are not marked as &quot;Future&quot;.</p>
<div class="figure">
<img src="_images/calendar-filtered-by-tag.jpg" /><p class="caption"></p>
</div>
<h2 id="code-listing">Code listing</h2>
<p>Code in <code>Page_Controller</code>:</p>
<pre><code>:::php
public function parseEventParams() {
    $year = $this-&gt;request-&gt;getVar(&#39;year&#39;);
    $month = $this-&gt;request-&gt;getVar(&#39;month&#39;);
    if (isset($year)) $year = (int)$year;
    if (isset($month)) $month = (int)$month;

    // Default to current month if either not provided.
    if (!isset($month) || !isset($year)) {
        $year = SS_Datetime::now()-&gt;Format(&#39;Y&#39;);
        $month = SS_Datetime::now()-&gt;Format(&#39;m&#39;);
    }

    return array(
        &#39;year&#39; =&gt; $year,
        &#39;month&#39; =&gt; $month
    );
}

/**
 * Prepare the data structure on which navigation can be built.
 */
public function SiteEventMonths() {
    $params = $this-&gt;parseEventParams();

    return EventHolder::ExtractMonths(
        EventHolder::AllEvents(),
        null,
        $params[&#39;year&#39;],
        $params[&#39;month&#39;]
    );

}

/**
 * Produce a list of events, as assigned to the current or currently selected month.
 */
public function SiteEvents() {
    $params = $this-&gt;parseEventParams();

    return EventHolder::AllEvents(null, null, null, null, $params[&#39;year&#39;], $params[&#39;month&#39;]);
}</code></pre>
<p>Template in <code>Page.ss</code>:</p>
<pre><code>:::ss
&lt;div class=&quot;span3 well&quot;&gt;

    &lt;h3&gt;Site events&lt;/h3&gt;

    &lt;% if SiteEvents %&gt;
        &lt;% loop SiteEvents %&gt;
            &lt;div class=&quot;event-listing&quot;&gt;
                &lt;h4&gt;&lt;a href=&quot;$Link&quot;&gt;$Title&lt;/a&gt;&lt;/h4&gt;
                &lt;p&gt;$Date.Nice&lt;/p&gt;
            &lt;/div&gt;
        &lt;% end_loop %&gt;
    &lt;% else %&gt;
        &lt;p&gt;No events. Please use the month picker below to select another period.&lt;/p&gt;
    &lt;% end_if %&gt;

    &lt;div class=&quot;event-listing-pagination&quot;&gt;
        &lt;h5&gt;Pick a month&lt;/h5&gt;

        &lt;% if SiteEventMonths %&gt;
            &lt;div class=&quot;month-filter&quot;&gt;
                &lt;% loop SiteEventMonths %&gt;
                    &lt;h6 class=&quot;year&quot;&gt;$YearName:&lt;/h6&gt;
                    &lt;ol class=&quot;nav nav-pills unstyled months&quot;&gt;
                    &lt;% loop Months %&gt;
                        &lt;li &lt;% if Active %&gt;class=&quot;active&quot;&lt;% end_if %&gt;&gt;&lt;a href=&quot;$MonthLink.XML&quot;&gt;$MonthName&lt;/a&gt;&lt;/li&gt;
                    &lt;% end_loop %&gt;
                    &lt;/ol&gt;
                &lt;% end_loop %&gt;
            &lt;/div&gt;
        &lt;% end_if %&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
